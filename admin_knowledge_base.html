<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base - AgriChatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .article-card {
            transition: transform 0.2s;
            height: 100%;
        }
        .article-card:hover {
            transform: translateY(-5px);
        }
        .category-badge {
            font-size: 0.8rem;
        }
        .article-content {
            max-height: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-seedling me-2"></i>AgriChatbot
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/super-dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/queries">
                            <i class="fas fa-question-circle me-1"></i>All Queries
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/knowledge-base">
                            <i class="fas fa-book me-1"></i>Knowledge Base
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/users">
                            <i class="fas fa-users-cog me-1"></i>Admin Users
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <span class="nav-link text-light">
                            <i class="fas fa-user me-1"></i>{{ session.get('admin_username', 'Admin') }}
                        </span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-danger" href="/admin/logout">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="mb-0"><i class="fas fa-book me-2"></i>Knowledge Base</h3>
                            <div>
                                <a href="/expert/knowledge" class="btn btn-light btn-sm me-2">
                                    <i class="fas fa-plus me-1"></i>Add New Article
                                </a>
                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#dbFixModal">
                                    <i class="fas fa-tools me-1"></i>Fix Database
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-success text-white text-center mb-3">
                                    <div class="card-body">
                                        <h5>Total Articles</h5>
                                        <h2>{{ statistics.total_articles }}</h2>
                                    </div>
                                </div>
                            </div>
                            {% for category, count in statistics.category_counts.items() %}
                            <div class="col-md-3">
                                <div class="card bg-info text-white text-center mb-3">
                                    <div class="card-body">
                                        <h5>{{ category|title }} Articles</h5>
                                        <h2>{{ count }}</h2>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if not statistics.has_timestamps %}
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Database Schema Issue:</strong> Timestamp columns are missing from the knowledge base table.
                            <button class="btn btn-sm btn-outline-dark ms-2" data-bs-toggle="modal" data-bs-target="#dbFixModal">
                                Fix Now
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            {% for article in articles %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card article-card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">{{ article.title }}</h5>
                        <span class="badge bg-secondary category-badge">{{ article.category }}</span>
                    </div>
                    <div class="card-body">
                        <div class="article-content">
                            <p class="card-text">{{ article.content }}</p>
                        </div>
                        <div class="mt-2">
                            {% if article.keywords %}
                            <div class="mb-2">
                                {% for keyword in article.keywords.split(',') %}
                                <span class="badge bg-light text-dark me-1">{{ keyword.strip() }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        {% if statistics.has_timestamps %}
                        <small class="text-muted">
                            Created: {{ article.created_at.strftime('%Y-%m-%d') }}
                            {% if article.updated_at %}
                            <br>Updated: {{ article.updated_at.strftime('%Y-%m-%d') }}
                            {% endif %}
                        </small>
                        {% endif %}
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary view-article" 
                                    data-title="{{ article.title }}"
                                    data-content="{{ article.content }}"
                                    data-category="{{ article.category }}"
                                    data-keywords="{{ article.keywords }}"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#articleModal">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <a href="/expert/knowledge?edit={{ article.article_id }}" class="btn btn-sm btn-outline-warning">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Article Modal -->
    <div class="modal fade" id="articleModal" tabindex="-1" aria-labelledby="articleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="articleModalLabel">Article Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Title:</label>
                        <p id="modalArticleTitle" class="fw-bold"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Category:</label>
                        <p id="modalArticleCategory"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Keywords:</label>
                        <p id="modalArticleKeywords"></p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Content:</label>
                        <div id="modalArticleContent" class="border p-3 bg-light"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Fix Modal -->
    <div class="modal fade" id="dbFixModal" tabindex="-1" aria-labelledby="dbFixModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dbFixModalLabel">Fix Database Schema</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>This will add the missing timestamp columns to your knowledge_article table:</p>
                    <ul>
                        <li><code>created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</code></li>
                        <li><code>updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP</code></li>
                    </ul>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This operation will modify your database schema. Make sure to backup your database first.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="fixDatabaseBtn">Fix Database</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3 bg-dark text-white text-center">
        <p class="mb-0">AgriChatbot Knowledge Base &copy; 2025</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // View article details in modal
        document.querySelectorAll('.view-article').forEach(button => {
            button.addEventListener('click', function() {
                document.getElementById('modalArticleTitle').textContent = this.getAttribute('data-title');
                document.getElementById('modalArticleCategory').textContent = this.getAttribute('data-category');
                document.getElementById('modalArticleKeywords').textContent = this.getAttribute('data-keywords') || 'None';
                document.getElementById('modalArticleContent').textContent = this.getAttribute('data-content');
            });
        });

        // Fix database schema
        document.getElementById('fixDatabaseBtn').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Fixing...';
            
            fetch('/admin/fix-knowledge-base-schema', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Database schema fixed successfully! The page will now reload.');
                    location.reload();
                } else {
                    alert('Error fixing database: ' + data.error);
                    this.disabled = false;
                    this.innerHTML = 'Fix Database';
                }
            })
            .catch(error => {
                alert('Error fixing database: ' + error);
                this.disabled = false;
                this.innerHTML = 'Fix Database';
            });
        });

        // Search functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'Search knowledge base...';
            searchInput.className = 'form-control mb-3';
            
            const articlesContainer = document.querySelector('.row');
            const articles = articlesContainer.querySelectorAll('.col-md-6');
            
            searchInput.addEventListener('keyup', function() {
                const searchText = this.value.toLowerCase();
                
                articles.forEach(article => {
                    const text = article.textContent.toLowerCase();
                    article.style.display = text.includes(searchText) ? '' : 'none';
                });
            });
            
            articlesContainer.parentNode.insertBefore(searchInput, articlesContainer);
        });
    </script>
</body>
</html>